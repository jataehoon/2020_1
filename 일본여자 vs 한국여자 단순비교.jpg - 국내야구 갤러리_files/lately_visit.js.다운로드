$(function(){
	if($('#lyr_lately_galls-tmpl').index() < 0) {
		return false;
	}
	
	var visit_elm = $('#visit_history_lyr');
	var segment = window.location.pathname.split('/');
	var limit = 16;
	var page = 1;
	var last_page = 0;
	var crossDoaminStorageOptions = {
		    origin: "https://gall.dcinside.com",
		    path: "/_js/crossDomainStorage.html",
		    storage: "localStorage"
		};

	if(typeof(storage) == 'undefined') {
		storage = new crossDomainStorage(crossDoaminStorageOptions);
	}
	

	storage.getItem('lately_gallery', function(key, value) {
		var strg_galls = $.parseJSON(value);

		if(strg_galls && strg_galls.length > 0) {
			$('.page_gall .total_num').text(Math.ceil(strg_galls.length / limit));
			$('#lyr_lately_galls-tmpl').tmpl(strg_galls).appendTo('#visit_history_lyr .gall');
			$('#visit_history_lyr .gall li').slice(0, limit).show();
			if(strg_galls.length > limit) {
				$('#lately_next').addClass('on');
			}

			// 삭제
			$('.pop_visit_list.gall .btn_del', visit_elm).click(function() {
				lately_gall_delete(this, page, limit);
			});
		}
		else {
			$('#visit_history_lyr .gall_msg.empty_box').show();
		}
	});

	storage.getItem('lately_gallog', function(key, value) {
		var strg_gallogs = $.parseJSON(value);
		
		if(strg_gallogs && strg_gallogs.length > 0) {
			$('.page_gallog .total_num').text(Math.ceil(strg_gallogs.length / limit));
			$('#lyr_lately_gallogs-tmpl').tmpl(strg_gallogs).appendTo('#visit_history_lyr .gallog');
			$('#visit_history_lyr .gallog li').slice(0, limit).show();

			
			// 삭제
			$('.pop_visit_list.gallog .btn_del', visit_elm).click(function() {
				lately_gall_delete(this, page, limit);
			});
		}
	});
	
	// 방문 기록 삭제
	var lately_gall_delete = function (elm, page, limit) {
		var storage_name = $('#visit_history_lyr .gall').css('display') == 'block' ? 'gallery' : 'gallog';
		
		var id = $(elm).attr('data-id');
		var eq = $(elm).parent().index();
		
		if($('li', $(elm).closest('.pop_visit_list')).length <= 1) {
			var type = $(elm).closest('.pop_visit_list').hasClass('gallog') ? 'gallog' : 'gall';
			$('#visit_history_lyr .'+type+'_msg.empty_box').show();
		}
		
		$(elm).parent().remove();
		
		storage.getItem('lately_'+ storage_name, function(key, value) {
			var lately = value;
			
			strg = modify_storage_json(lately, id);
			storage.setItem('lately_'+ storage_name, JSON.stringify(strg));
			
			var latelyTotal = Math.ceil(strg.length / limit);
			
			var class_name = storage_name == 'gallery' ? 'page_gall' : 'page_gallog';
			
			$('.'+ class_name +' .total_num').text(latelyTotal);
			
			if(page > latelyTotal && page > 1) {
				latelyPageMove(false, limit);
			}
		});
	}
	
	var modify_storage_json = function (jsonData, id) {
		var new_data = new Array();
		var strg_galls = $.parseJSON(jsonData);
		
		for(var i in strg_galls) {
			if(strg_galls[i] && typeof(strg_galls[i].id) != 'undefined' && strg_galls[i].id != id) {
				new_data.push(strg_galls[i]);
			}
		}
		
		return new_data;
	}
	
	// 페이지 이동
	var latelyPageMove = function (is_next, limit) {
		var type = $('#visit_history_lyr .gall').css('display') == 'block' ? 'gall' : 'gallog';

		var nowNum = $('.page_'+type+' .now_num').text();
		var latelyTotal = $('.page_'+type+' .total_num').text();
	
		if(is_next) {
			nowNum++;
			
			if (nowNum > latelyTotal) {
				nowNum = 1;
				page = 1;
			} else {
				page = nowNum;
			}
		}
		else {
			nowNum--;
			
			if (nowNum <= 0) {
				nowNum = latelyTotal;
				page = latelyTotal - 1;
			} else {
				page = nowNum - 1;
			}
		}
	
		$('#lately_prev').addClass('on');
		$('#lately_next').addClass('on');
		
		if (nowNum == 1)				$('#lately_prev').removeClass('on');
		if (nowNum == latelyTotal)		$('#lately_next').removeClass('on');

		$('.page_'+type+' .now_num').text(nowNum);
		$('#visit_history_lyr .'+type+' li').hide();
		$('#visit_history_lyr .'+type+' li').slice((parseInt(nowNum)-1)*limit , parseInt(nowNum)*limit).css('display','block');
	}
	
	// 최근방문 이전
	$('#lately_prev').click(function(){
		latelyPageMove(false, limit);
	});
	//최근방문 이후
	$('#lately_next').click(function(){
		latelyPageMove(true, limit);
	});
});

function openLately() {

	if($('#visit_history_lyr').css('display') == 'block'){
		$('#visit_history_lyr').hide();
		$('.icon_visit').removeClass('hide');
	}
	else{	
		$('#visit_history_lyr').show();
		$('.icon_visit').addClass('hide');
	}
}

function closeLately() {
	$('#visit_history_lyr').hide();
	$('.icon_visit').removeClass('hide');
}

function tabLately(type){
	$('.pop_visit_list').hide();
	$('.visit .'+type).show();
	
	$('#visit_history_lyr .page_num').hide();
	$('#visit_history_lyr .page_'+type).show();
	
	$('.visitab_box button').removeClass('on');
	$('.visitab_box .'+type+'Tab').addClass('on');

	$('#visit_history_lyr .'+type+' li').hide();
	$('#visit_history_lyr .'+type+' li').slice(0, 16).show();

	$('#visit_history_lyr .empty_box').hide();

	if($('.page_'+type+' .total_num').text() > 1) {
		$('#lately_next').addClass('on');
	}
	else if($('#visit_history_lyr .'+type+' li').length < 1) {
		$('#visit_history_lyr .'+type+'_msg.empty_box').show();
	}

	$('#lately_prev').removeClass('on');
	$('.page_'+type+' .now_num').text(1);
}