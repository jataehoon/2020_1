/*
 * 통합검색 자동완성 script
 *
 * jhcho - 2015.12.11
 * 통함검색 추가 - jhcho - 2016.09.07
 */

if (typeof(beta) == "undefined")
    _beta = beta = {};

if (typeof(_beta.fix) == "undefined")
    _beta.fix = {};
else
    alert("keyfix is already set!");

if(typeof(window.beta.instances) == "undefined")
    window.beta.instances = new Array();

_beta.fix = function(targetId)
{
    // this fix is only for mozilla browsers
    //if(jQuery.browser.mozilla == false)
      //  return false;
	if( navigator.userAgent.toLowerCase().indexOf('firefox') < 0 ) {
		return false;
	} 
	
    var thisClass = this;
    this.keyEventCheck = null;
    this.db = null;
    this.targetId = targetId;
    window.beta.instances[this.targetId] = this;

    var focusFunc = function()
    {
        if(!thisClass.keyEventCheck) thisClass.watchInput();
    }

    var blurFunc = function()
    {
        if(thisClass.keyEventCheck)
        {
            window.clearInterval(thisClass.keyEventCheck);
            thisClass.keyEventCheck = null;
        }
    }

    $("#" + this.targetId).bind("focus", focusFunc);
    $("#" + this.targetId).bind("blur", blurFunc);
};

_beta.fix.prototype.watchInput = function()
{
    if(this.db != $("#" + this.targetId).val())
    {
        // trigger event
        $("#" + this.targetId).keyup();
        this.db = $("#" + this.targetId).val();
    }

    if(this.keyEventCheck) window.clearInterval(this.keyEventCheck);
    this.keyEventCheck = window.setInterval("window.beta.instances['" + this.targetId + "'].watchInput()", 100);
};



globalSearch = function(f) {
	
	var keyword = $('input[name="search"]', f).val();
	var action = $(f).attr('action') ? $(f).attr('action').replace(/\/$/, '') : 'https://search.dcinside.com/combine';
	var url = action +'/q/'+ uri_encode(keyword);
	var dataTarget = $('input[name="search"]').attr('dataTarget')
	
	if(!keyword) {
		alert('검색어를 입력해주세요.');
		return false;
	}
	
	$.ajax({
		url: "https://search.dcinside.com/ajax/chkSearch/q/"+ keyword,
		type: "GET",
		dataType: "jsonp",
		async: true,
		contentType: "application/json; charset=utf-8",
		jsonp : "callback",
		jsonpCallback: "jsonpCallback",
		crossDomain: true,
		data: {},
		success: function(json, textStatus, jqXHR) {}
	});

	if(f.target) {
		window.open(url, f.target);
	}
	else {
		if(dataTarget == 'mall')	window.open(url, '_top');
		else	location.href = url;
	}

	return false;
}

uri_encode = function(keyword) {
	keyword = encodeURIComponent(keyword).replace(/\./g, '%2E').replace(/~/g, '%7E').replace(/\!/g, '%21').replace(/\*/g, '%2A').replace(/\(/g, '%28').replace(/\)/g, '%29').replace(/'/g, '%27');
	return keyword.replace(/%/g, '.');
}

$(document).ready(function() {
	var inputId = $('#gn_top_search_0').index() < 0 ? 'preSWord' : 'gn_top_search_0'; // 메인은 id값이 다름
	var keyFix = new beta.fix(inputId);
	var search_title = ['갤러리 검색결과', '마이너 갤러리 검색결과', '미니 갤러리 검색결과', '추천 갤러리', '디시위키 검색결과'];						// 자동완성 레이어 타이틀명
	var input_el = $('#'+inputId);
	var search_el = '.top_search';
	var doc = document;
	var autocomplete_time = 0;
	
	// 검색 버튼
	/*
	$('.btn_globalSearch').click(function() {
		var form = $(this);
		
		for(var $i = 0; $i < 100; $i++) {
			if(form[0].tagName == 'FORM') {
				form.submit();
				break;
			}
			form = form.parent();
		}
	});
	*/
	// iframe으로 삽입된 경우 자동완성 레이어가 가려지기 때문에 부모창에 출력함
	// 부모창 보안 에러시 예외 발생
	var search_el_top = $(search_el).position().top + $(search_el).outerHeight();
	var search_el_left = $(search_el).position().left;
	try {
		if(window.location.host != window.parent.location.host) {
			search_el_top = search_el_top + $(search_el).offset().top;
			search_el_left = $(search_el).offset().left;
			
			search_el = 'iframe[src="'+ window.location +'"]';
			doc = window.parent.document;
			
			if(window.location.host + window.location.pathname != 'gn.dcinside.com/top/top_dccon.php') {
				$(search_el, doc).after('<link href="//nstatic.dcinside.com/dc/w/css/reset.css"/>');
				$(search_el, doc).after('<link href="//nstatic.dcinside.com/dc/w/css/common.css"/>');
				$(search_el, doc).after('<link href="//nstatic.dcinside.com/dc/w/css/contents.css"/>');
			}
		}
	}
	catch(e) { return; }
	
	$(search_el, doc).after('<div class="auto_wordwrap" style="left:'+ search_el_left +'px;top:'+ search_el_top +'px;display:none"></div>');

	var searchFocus = 1;
	var moveLink = "";
	input_el.keyup(function(event) {
		//if(typeof event.keyCode === 'undefined') return;
		
		if(event.keyCode == '40' || event.keyCode == '38' || event.keyCode == '13') return;

		if(this.getAttribute('data-custom-autocomplete') == 'false') return;
		
		var keyword = $(this).val();
		
		if(keyword == '' || keyword.length < 1) {
			if($('#tmpl_search').index() >= 0) $('#tmpl_search').parent().hide().html('');
			if($('.auto_wordwrap', doc).eq(0).index >= 0) $('.auto_wordwrap', doc).eq(0).hide().html('');
			return;
		}
		
		if($(this).attr('data-sentKeyword') == keyword) {
			return;
		}
		else {
			$(this).attr('data-sentKeyword', keyword);		// keyup 이벤트가 두번씩 실행됨
		}

		$.ajax({
			url: "https://search.dcinside.com/autocomplete?callback=?",
			type: "GET",
			dataType: "jsonp",
			contentType: "application/json; charset=utf-8",
			data: {
				t: new Date().getTime(),
				k: keyword
			},
			success: function(json, textStatus, jqXHR) {
				var empty = true;
				var html = '<div id="tmpl_search" class="auto_word">';

				if(autocomplete_time > json.time) {
					return ;
				}
				
				var nKeyIdx = 1;
				for(var i in json) {
					if(json[i].length > 0 && search_title[i] != undefined) {
						
						html += '<div class="word_box">';
				        if (i == 3) html += '<h3 class="word_tit">'+ search_title[i] + '</h3>';
				        else html += '<h3 class="word_tit">'+ search_title[i] +'</h3>';
				        html += '<ul class="word_list">';

						for(var j in json[i]) {							
							var subject = href = '';
							var aclass = '';
							var icon_restriction = '';
							var icon_mini = '';
							var gall_url = 'https://gall.dcinside.com/board/lists'; 
							
							if(json[i][j].galleryId == 'singo') gall_url = 'https://gall.dcinside.com/singo';

							// 갤러리
							if(json[i][j].ko_name != undefined) {
								if(json[i][j].ko_name == 'DNA'){
									subject = json[i][j].ko_name;
									href = 'http://dc.news-ade.com/'; 
								}else{
									subject = json[i][j].ko_name;
									href = gall_url + '/?id='+ json[i][j].name;
								}
							}

							// m.갤러리
							if(json[i][j].m_ko_name != undefined) {
								subject = json[i][j].m_ko_name;
								href = 'https://gall.dcinside.com/m/list.php?id='+ json[i][j].name;
								if(json[i][j].state == 'N') {
									aclass = ' class="restriction"';
									icon_restriction = '<span><em class="blind">접근제한</em><em class="sp_img icon_restriction"></em></span>';
								}
							}
							
							// n.갤러리
							if(json[i][j].mini_ko_name != undefined) {
								subject = json[i][j].mini_ko_name;
								href = 'https://gall.dcinside.com/mini/board/lists/?id='+ json[i][j].name;
								if(json[i][j].state == 'N') {
									aclass = ' class="restriction"';
									icon_restriction = '<span><em class="blind">접근제한</em><em class="sp_img icon_restriction"></em></span>';
								}
							}

							// 추천 갤러리
							if(json[i][j].o_gallName != undefined) {
								subject = json[i][j].o_gallName;
								href = 'https://gall.dcinside.com/list.php?id='+ json[i][j].galleryId;
								href = gall_url + '/?id='+ json[i][j].galleryId;
								if(json[i][j].state == 'N') {
									aclass = ' class="restriction"';
									icon_restriction = '<span><em class="blind">접근제한</em><em class="sp_img icon_restriction"></em></span>';
								}
							}
							//추천 미니갤러리
							if(json[i][j].mini_o_gallName != undefined) {
								subject = json[i][j].mini_o_gallName;
								href = 'https://gall.dcinside.com/mini/board/lists/?id='+ json[i][j].galleryId;
								icon_mini = '<em class="icon_mini">ⓝ</em>';
								if(json[i][j].state == 'N') {
									aclass = ' class="restriction"';
									icon_restriction = '<span><em class="blind">접근제한</em><em class="sp_img icon_restriction"></em></span>';
								}
							}

							// 디시위키
							if(json[i][j].title != undefined) {
								subject = json[i][j].title;
								href = 'https://wiki.dcinside.com/wiki/'+ encodeURIComponent(json[i][j].title);
							}

							html += '<li class="search_key" id="search_key_idx_'+(nKeyIdx++)+'"><a href="'+ href +'"'+aclass+'>'+ subject+icon_restriction+'</a>'+icon_mini+'</li>';
						}

						html += '</ul>';
						html += '</div>';

						empty = false;
					}
				}

				if(empty) {
					if($('#tmpl_search').index() >= 0) $('#tmpl_search').parent().hide().html('');
					if($('.auto_wordwrap', doc).eq(0).index >= 0) $('.auto_wordwrap', doc).eq(0).hide().html('');
					return;
				}
				
				html += '</div>';
				html += '<div class="word_close">';
				html += '<a href="javascript:;" onclick="$(\'#tmpl_search\').parent().hide().html(\'\');" class="sp_img btn_close"><span class="blind">자동완성 레이어 닫기</span></a>';
				html += '</div>';
				
				autocomplete_time = json.time;
				
				if($('.top_box').index() > -1) {
					var gap = $('#dgn_gall_top .top_box', doc).index() > -1 ? $('#dgn_gall_top .top_box', doc).offset().top : 0;
					var auto_wordwrap_top = $('.top_box').offset().top + $('.top_box').outerHeight() - gap + 1;
					$('.auto_wordwrap', doc).css("top", auto_wordwrap_top +"px");
				}
				
				$('.auto_wordwrap').css("left",  $(search_el, doc).position().left +"px");
				$('.auto_wordwrap', doc).eq(0).html(html).show();
			
				/*
				 * 스크롤 없애는 것으로 기획변경 20160909
				if($('#tmpl_search').height() > 377 )	{
					$('#tmpl_search').css('height', '377px');
					$('#tmpl_search').css('overflow-x', 'hidden')
				}
				*/
			}
		});
	}).keydown(function(event) {

		if(typeof event.keyCode === 'undefined') return;

		var nKeyList = $(".search_key").length;

		if(event.keyCode == 40) {
			event.preventDefault ? event.preventDefault() : (event.returnValue = false);
			if($(".search_key").hasClass("on") !== false){
				//console.log(searchFocus);
				if(searchFocus >= nKeyList) {
					return;
				}

				$(".search_key").removeClass("on");
				$(".search_key").css("background-color","#fff");

				searchFocus++;

				$("#search_key_idx_"+searchFocus).addClass("on");
				$("#search_key_idx_"+searchFocus).css("background-color","#f6f6f8");
				$('input[name="search"]').val($("#search_key_idx_"+searchFocus+" a").text());
				moveLink = $("#search_key_idx_"+searchFocus+" a").attr("href");
			} else {
				//console.log('first');
				$("#search_key_idx_1").addClass("on");
				$("#search_key_idx_1").css("background-color","#f6f6f8");
				$('input[name="search"]').val($("#search_key_idx_1 a").text());
				moveLink = $("#search_key_idx_1 a").attr("href");
			}
			
			return;
		}

		if(event.keyCode == 38) {
			event.preventDefault ? event.preventDefault() : (event.returnValue = false);
			if(searchFocus <= 1) {
				return;
			}
			$(".search_key").removeClass("on");
			$(".search_key").css("background-color","#fff");

			searchFocus--;

			$("#search_key_idx_"+searchFocus).addClass("on");
			$("#search_key_idx_"+searchFocus).css("background-color","#f6f6f8");
			$('input[name="search"]').val($("#search_key_idx_"+searchFocus+" a").text());

			moveLink = $("#search_key_idx_"+searchFocus+" a").attr("href");
			return;
				
		}
	
		if(event.keyCode == 13) {
			event.preventDefault ? event.preventDefault() : (event.returnValue = false);
			if(moveLink !== "") {
			
				location.href = moveLink;
			} else {
				
				var searchForm = $('form[id="searchform"]');
				
				globalSearch(searchForm);
			}
			/*if($('input[name="search"]').val() == ""){
				alert('검색어를 입력해주세요!!');
				return;
			}

			if(moveLink !== "") {
				location.href = moveLink;
			} else {
				location.href = 'http://search.dcinside.com/combine/q/'+$('input[name="search"]').val();
			}*/
		}
	});
});

function jsonpCallback(json) {}
